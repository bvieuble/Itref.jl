using Itref
using Test
using LinearAlgebra
using Quadmath

@testset "Itref.jl" begin
    h=Float16
    s=Float32
    d=Float64
    q=Float128

    AK2 = [ 0.13672310429944956  -0.12919778907800233   0.7741714205544146   -0.41565873602944525   0.10145828874291091;
            0.4724518687389614    0.31449990139846185   0.3378671863628081    0.1517631054226502   -0.635384821457541;
            0.04756834753204395  -0.5013849397869287   -0.0506445685880077   -0.5799159753889944   -0.006436178260588926;
            0.8324203826937465   -0.3085176779623514   -0.20128583418212703   0.2079214915301442    0.33428117056783524;
            0.07469515096182203  -0.22877401631370853  -0.41288817369573083  -0.3107031252113317   -0.646683650930063];

    AK4 = [ 0.6998690252049433     0.17822557153333404   0.002692531397366832  -0.6032844498327263   -0.33794279329596333;
            0.011028907234819946   0.15461080673714048   0.23978783034380408   -0.2652613661165255    0.544789988930614;
            -0.6829975283554617     0.3877109520594715    0.16844979095098928   -0.47814971527500094  -0.35335023769425966;
            -0.03538487063016396    0.04428081679165369  -0.5091418251914096     0.24826651935274036  -0.5269593581810209;
            0.001628922080304046  -0.5685312038053489    0.6763745931619076     0.05991696832398802  -0.4084632481941833];

    AK6 = [ 0.014127429193286911   0.16624968845693677   0.5612588991504996    0.3196175837649924    0.16865203662589012;
            0.13084897485745953    0.06660606399136304   0.5750944800925943   -0.01613213851094917   0.5533831619462461;
            -0.585169531999103     -0.28521691775416885  -0.18688393557290167  -0.3484404907729635    0.6041280833498285;
            -0.3934189427728066     0.7726032083406641    0.14162729107945932  -0.42989451569822723  -0.2041221410534118;
            -0.6794884365150842    -0.06416982444307237   0.07850838805287008   0.6468754758150794   -0.18446079449811872];

    AK8 = [ 0.5266491023287277    -0.31792918744045295   -0.36542432365490113  -0.4514948891714226     0.03279388393752769;
            -0.38685614987496975    0.17465384224461444    0.351540285664817     0.06358241814517251    0.3338303719619681;
            0.32241322055495913    0.17541192973839514   -0.2565873118618979    0.35146174892606896    0.8097499794847218;
            -0.054802283077288794  -0.024331843808722067   0.40796878961553534  -0.7379966537151784     0.41835642233055276;
            0.5647730810863013     0.7074920096474066     0.34136906710589227  -0.044788607905225916  -0.23738483885254572];

    AK10 = [0.6692625696349717   -0.14427007525612334   0.4376035898636872    0.45438902891727206   -0.3268999835646051;
            -0.09629611711186709   0.42034212303014795  -0.07412038640548468  -0.32290370107845695   -0.7018035070947244;
            -0.3673307077006614   -0.3021490431152235    0.47366713439379815  -0.047656484463151405   0.28805191232614386;
            0.3060992429173445   -0.7195929665018638   -0.33824098583338164  -0.4929173003913386    -0.14088018141090003;
            0.2863753381091002    0.20980155288842928  -0.6051910883071969    0.29803460506806656    0.3640361170763489];

    AK12 = [-0.35968077417175137  -0.23418436563468958   0.1435023647231756   -0.8573082798338418   -0.13978297609365797;
            0.35511662150389     -0.6600806055140831   -0.14976386020642707   0.18236833798780228  -0.2989982101794847;
            -0.2735002153048802   -0.4689752220211353   -0.23996459771393894   0.09946671483776362  -0.38024006325929427;
            -0.7117225423798985    0.01567661470527315  -0.4986644522215094    0.2651676008774775    0.19745696521304484;
            0.257496172547416    -0.35738633283286936  -0.34464614445190056  -0.23929482550890593   0.7695066976779356];

    AK14 = [0.2876223131989385   -0.3469207993088014   -0.6604410646858047   -0.49821407108637616  -0.27535567317834597;
            0.5961172861824781   -0.42063348270947787   0.6491570401497399   -0.20358224306786515  -0.06033335893972838;
            -0.1409520591214426   -0.7343624834084079   -0.19047622848081414   0.36112602393172943   0.5147402431375581;
            0.04116594955577332   0.00596735605700268  -0.13196986385507267  -0.1044969448091819   -0.13739558697792914;
            0.17857447311610417   0.2999553432639903   -0.05236619069817405  -0.4920072192662205    0.7946663620599511];
    
    AK16 = [0.29025968083089715   -0.4907082754826567  -0.7504521528635728   -0.27675265584898356   0.06746008892130634;
            -0.694194686505666      0.1918498060300583  -0.09918942190141494  -0.6442934381269635    0.022886061738557513;
            0.6335280352653113     0.5343543369184458   0.11566898909661227  -0.5114112603572547    0.1847807933168457;
            0.025840094688045632   0.2205365004508255  -0.06016093743385569   0.37724420004105064   0.047131511123566935;
            0.1521587305157892    -0.5839262274216623   0.6155384974326705   -0.32038708852325565  -0.21765051260021528];

    A_list = [AK2, AK4, AK6, AK8, AK10, AK12, AK14, AK16]

    # GMRES-IR : SDQDD
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        Ar          = nothing

        x, bkw, fwd, it, gmresits, cvg = itref(A, b;
                                               isgmres=true,
                                               xexact=xexact,
                                               nitmax=50, 
                                               bstop=1e-15,
                                               fstop=1e-15,
                                               verbose=false,
                                               tol=1e-12, 
                                               uf=s,
                                               uw=d,
                                               ur=q,
                                               ug=d,
                                               up=q);

        @test bkw[end] < 1e-15 && fwd[end] < 1e-15 && cvg
    end

    # GMRES-IR : HDQDQ
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        Ar          = nothing

        x, bkw, fwd, it, gmresits, cvg = itref(A, b;
                                               isgmres=true,
                                               xexact=xexact,
                                               nitmax=50, 
                                               bstop=1e-15,
                                               fstop=1e-15,
                                               verbose=false,
                                               tol=1e-12, 
                                               uf=h,
                                               uw=d,
                                               ur=q,
                                               ug=d,
                                               up=q);

        @test bkw[end] < 1e-15 && fwd[end] < 1e-15 && cvg
    end

    # GMRES-IR : HDQSS
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        Ar          = nothing

        x, bkw, fwd, it, gmresits, cvg = itref(A, b;
                                               isgmres=true,
                                               xexact=xexact,
                                               nitmax=50, 
                                               bstop=1e-15,
                                               fstop=1e-15,
                                               verbose=false,
                                               tol=1e-6, 
                                               uf=h,
                                               uw=d,
                                               ur=q,
                                               ug=s,
                                               up=s);

        if cond(A)<1e8
            @test bkw[end] < 1e-15 && fwd[end] < 1e-15 && cvg
        else
            @test fwd[end] > 1e-15 && !cvg
        end
    end

    # LU-IR : HDQ
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        Ar          = nothing

        x, bkw, fwd, it, gmresits, cvg = itref(A, b;
                                               xexact=xexact,
                                               nitmax=50, 
                                               bstop=1e-15,
                                               fstop=1e-15,
                                               verbose=false,
                                               uf=h,
                                               uw=d,
                                               ur=q);
        if cond(A)<1e5
            @test bkw[end] < 1e-15 && fwd[end] < 1e-15 && cvg
        else
            @test fwd[end] > 1e-15 && !cvg
        end
    end

    # LU-IR : SDQ
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        Ar          = nothing

        x, bkw, fwd, it, gmresits, cvg = itref(A, b;
                                               xexact=xexact,
                                               nitmax=50, 
                                               bstop=1e-15,
                                               fstop=1e-15,
                                               verbose=false,
                                               uf=s,
                                               uw=d,
                                               ur=q);
        if cond(A)<1e8
            @test bkw[end] < 1e-15 && fwd[end] < 1e-15 && cvg
        else
            @test fwd[end] > 1e-15 && !cvg
        end
    end

    Ar          = convert(Array{q,2}, AK2);
    xexact      = rand(q,size(Ar,1));
    b           = Ar*xexact;
    Ar          = nothing

    x, bkw, fwd, it, gmresits, cvg = itref(AK2, b;
                                           isgmres=true,
                                           xexact=xexact,
                                           nitmax=50, 
                                           bstop=1e-15,
                                           fstop=1e-15,
                                           verbose=false,
                                           tol=1e-12, 
                                           uf=h,
                                           uw=d,
                                           ur=q,
                                           ug=d,
                                           up=q);
    @test cvg

    x, bkw, fwd, it, gmresits, cvg = itref(AK2, b; verbose=false);
    @test cvg

    x, bkw, fwd, it, gmresits, cvg = itref(AK2, b;
                                           isgmres=true,
                                           verbose=false);
    @test cvg

    F = lu(AK2);
    x, bkw, fwd, it, gmresits, cvg = itref(AK2, b;
                                           F=F,
                                           isgmres=true,
                                           bstop=1e-15,
                                           fstop=1e-15,
                                           verbose=false,
                                           tol=1e-12, 
                                           uw=d,
                                           ur=q,
                                           ug=s,
                                           up=d);
    @test cvg

    # GMRES restarted
    for A in A_list
        Ar          = convert(Array{q,2}, A);
        xexact      = rand(q,size(Ar,1));
        b           = Ar*xexact;
        F           = lu(convert(Array{h,2}, A));
        Ar          = nothing

        x, bkw, fwd, it, cvg = gmres(A, b, F;
                                     restrt=20, 
                                     tol=1e-6,
                                     bstop=1e-15,
                                     verbose=false,
                                     ug=d,
                                     up=q)
        @test cvg
    end
end
